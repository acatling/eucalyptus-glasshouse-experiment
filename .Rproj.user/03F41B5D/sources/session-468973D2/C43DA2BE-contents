########## Above-ground biomass models
#### Linear, quadratic, cubic - all fixed, then
## Random intercept, intercept and slope, intercept slope and curvature
AbovegroundBiomass <- read.csv("C:/Users/Alexandra/OneDrive - Australian National University/Honours/Honours R/abovegroundbiomass.csv")
head(AbovegroundBiomass)
AbovegroundBiomass$Line <- as.factor(AbovegroundBiomass$Line)
sum(is.na(AbovegroundBiomass$AbovegroundBiomass))
AbovegroundBiomass <- AbovegroundBiomass[complete.cases(AbovegroundBiomass), ]
sum(is.na(AbovegroundBiomass$AbovegroundBiomass))
AbovegroundBiomass$Light <- as.numeric(AbovegroundBiomass$Light)
str(AbovegroundBiomass)
head(AbovegroundBiomass)
#### Visualising data ######

ggplot(AbovegroundBiomass, aes(x = SoilTemp, y = AbovegroundBiomass, group = Line)) + 
  geom_jitter(aes(colour = Line))+ 
  theme_bw()

ggplot(AbovegroundBiomass, aes(x=SoilTemp, y=AbovegroundBiomass)) + 
  geom_jitter(colour="lightblue", size=1.6) +
  theme_bw() +
  geom_point(stat="summary", fun.y="mean",size=2) +
  geom_errorbar(stat="summary", fun.data="mean_se",width=0,size=0.8)

###Going through each line
#201, 221, 213, 225, 239, 217, 229, 233, 241, 248, 223, 212
ggplot(AbovegroundBiomass, aes(x=SoilTemp, y=AbovegroundBiomass)) + 
  geom_jitter(colour="lightblue") + 
  geom_line(stat="summary", fun.y="mean") +
  geom_line(data=subset(AbovegroundBiomass, Line == "221"), colour="red", size=1) +
  theme_bw()


#### Basic linear model ####
# Fit a linear model for the fixed effect of SoilTemp on Tcrit
model1.1 <- lm(AbovegroundBiomass ~ SoilTemp + Light, data = AbovegroundBiomass)

# Check model summary and R squared values
par(mfrow=c(2,2))
plot(model1.1)
summary(model1.1)
par(mfrow=c(1,1))

# Plot the raw data and overlay the fit of Model1.1
ggplot(AbovegroundBiomass, aes(x = SoilTemp, y = AbovegroundBiomass, group = Line)) + 
  geom_jitter(aes(colour = Line)) +
  geom_abline(intercept = model1.1[1]$coefficients[1], 
              slope = model1.1[1]$coefficients[2], lwd = 2) +
  ylab("Tcrit") + xlab("SoilTemp") + theme_classic() 


#### Quadratic fixed effects model ####
# Fit a quadratic model for the fixed effect of SoilTemp on Tcrit
model1.2 <- lm(AbovegroundBiomass ~ poly(SoilTemp, 2, raw = T) + Light, data = AbovegroundBiomass)

# Check model summary and R squared values
par(mfrow=c(2,2))
plot(model1.2)
summary(model1.2)
par(mfrow=c(1,1))

# Predict values based on the model fit using the predict function
SoilTemp_pred <- data.frame(SoilTemp = seq(from = min(AbovegroundBiomass$SoilTemp),
                                   to = max(AbovegroundBiomass$SoilTemp),
                                   length.out = 50))
SoilTemp_pred$fit1.2 <- predict(model1.2, newdata = SoilTemp_pred, re.form = NA)

# Plot the overall model fit over the top of the raw data 
ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.2)) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, colour = Line)) +
  geom_line(size = 2) + 
  xlab("SoilTemp") +
  theme_classic()

# Are the two fixed effects models different? 
AIC(model1.1, model1.2)


####### Cubic fixed effects model ###
model1.3 <- lm(AbovegroundBiomass ~ poly(SoilTemp, 3, raw = T) + Light, data = AbovegroundBiomass)

par(mfrow=c(2,2))
plot(model1.3)
summary(model1.3)
anova(model1.3)
par(mfrow=c(1,1))

SoilTemp_pred <- data.frame(SoilTemp = seq(from = min(AbovegroundBiomass$SoilTemp),
                                   to = max(AbovegroundBiomass$SoilTemp),
                                   length.out = 50))

SoilTemp_pred$fit1.3 <- predict(model1.3, newdata = SoilTemp_pred, re.form = NA)

ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.3)) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, colour = Line)) +
  geom_line(size = 2) +
  ylab("Aboveground Biomass (g)") +
  theme_classic()

# Are the three fixed effects models different? 
AIC(model1.1, model1.2, model1.3)

#### Quadratic fixed effects with random intercepts model ####
# Fit a linear mixed effects model (random intercepts only) for the fixed effect of 
# SoilTemp on Tcrit and random effect of line intercepts
model1.4 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 2, raw = T) + (1|Line) + Light, data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.4)
r.squaredGLMM(model1.4)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.4 <- predict(model1.4, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.4  <- predict(model1.4, re.form = NA)
# Make predictions for each line-level reaction norm
AbovegroundBiomass$pred_line1.4 <- predict(model1.4, re.form = ~(1|Line))

# Plot predicted line reaction norms over the raw data, along with the overall mean
ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.4)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.4, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass,
            aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Tcrit") + xlab("SoilTemp") +
  theme_classic()

# Does adding line as a random intercept improve model fit?
AIC(model1.1, model1.2, model1.3, model1.4)


#### Quadratic fixed effects with random regression model ####
# Fit a linear mixed effects model for the fixed effect of SoilTemp on 
# Tcrit and random effect of line intercepts and slopes
model1.5 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 2, raw = T) + (1+SoilTemp|Line) + Light, 
                 data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.5)
r.squaredGLMM(model1.5)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.5 <- predict(model1.5, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.5  <- predict(model1.5, re.form = NA)
# Make predictions for the line-level reaction norms
AbovegroundBiomass$pred_line1.5 <- predict(model1.5, re.form = NULL)

# Plot predicted line reaction norms over the raw data, along with the overall mean
ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.5)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.5, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Tcrit") + xlab("SoilTemp") +
  theme_classic()

# Does adding line as a random intercept and slope further improve model fit? 
AIC(model1.1, model1.2, model1.3, model1.4, model1.5)



#### Quadratic fixed effects with random regression and curvature model ####
# Fit a linear mixed effects model for the fixed effect of SoilTemp on 
# Tcrit and random effect of line intercepts, slopes, and curvature
model1.6 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 2, raw = T) + (1 + scale(SoilTemp)|Line) + 
                   (I(scale(SoilTemp)^2)|Line), data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.6)
r.squaredGLMM(model1.6)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.6 <- predict(model1.6, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.6  <- predict(model1.6, re.form = NA)
# Make predictions for the line-level reaction norms
AbovegroundBiomass$pred_line1.6 <- predict(model1.6, re.form = NULL)

ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.6)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.6, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Above-ground biomass (g)") + xlab(soiltemp) +
  theme_classic()+
  theme(axis.title.y=element_text(margin = margin(t = 0, r = 15, b = 0, l = 0),face="bold"),
        axis.title.x=element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), face = "bold"),
        axis.title=element_text(size=20),
        axis.text = element_text(size=20))

# Does adding line as a random intercept, slope, and curvature further improve model fit? 
AIC(model1.1, model1.2, model1.3, model1.4, model1.5, model1.6)
 
####################### CUBIC MODELS INTERCEPT, SLOPE AND CURVATURE

#### Quadratic fixed effects with random intercepts model ####
# Fit a linear mixed effects model (random intercepts only) for the fixed effect of 
# SoilTemp on Tcrit and random effect of line intercepts
model1.7 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 3, raw = T) + (1|Line) + Light, data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.7)
r.squaredGLMM(model1.7)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.7 <- predict(model1.7, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.7  <- predict(model1.7, re.form = NA)
# Make predictions for each line-level reaction norm
AbovegroundBiomass$pred_line1.7 <- predict(model1.7, re.form = ~(1|Line))

# Plot predicted line reaction norms over the raw data, along with the overall mean
ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.7)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.7, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass,
             aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Tcrit") + xlab("SoilTemp") +
  theme_classic()

# Does adding line as a random intercept improve model fit?
AIC(model1.1, model1.2, model1.3, model1.4, model1.5, model1.6, model1.7)


#### Quadratic fixed effects with random regression model ####
# Fit a linear mixed effects model for the fixed effect of SoilTemp on 
# Tcrit and random effect of line intercepts and slopes
model1.8 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 3, raw = T) + (1+SoilTemp|Line) + Light, 
                 data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.8)
r.squaredGLMM(model1.8)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.8 <- predict(model1.8, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.8  <- predict(model1.8, re.form = NA)
# Make predictions for the line-level reaction norms
AbovegroundBiomass$pred_line1.8 <- predict(model1.8, re.form = NULL)

# Plot predicted line reaction norms over the raw data, along with the overall mean
ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.8)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.8, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Tcrit") + xlab("SoilTemp") +
  theme_classic()

# Does adding line as a random intercept and slope further improve model fit? 
AIC(model1.1, model1.2, model1.3, model1.4, model1.5, model1.6, model1.7, model1.8)



#### Cubic fixed effects with random regression and curvature model ####
# Fit a linear mixed effects model for the fixed effect of SoilTemp on 
# Tcrit and random effect of line intercepts, slopes, and curvature
model1.9 <- lmer(AbovegroundBiomass ~ poly(SoilTemp, 3, raw = T) + (1 + scale(SoilTemp)|Line) + 
                   (I(scale(SoilTemp)^2)|Line) + Light, data = AbovegroundBiomass)

# Check model summary and R squared values
summary(model1.9)
r.squaredGLMM(model1.9)

# Predict values based on the model fit using the predict function
SoilTemp_pred$fit1.9 <- predict(model1.9, newdata = SoilTemp_pred, re.form = NA)

# Make a prediction for the population-level mean reaction norm and append it to the AbovegroundBiomass dataset
AbovegroundBiomass$pred_pop1.9  <- predict(model1.9, re.form = NA)
# Make predictions for the line-level reaction norms
AbovegroundBiomass$pred_line1.9 <- predict(model1.9, re.form = NULL)

ggplot(SoilTemp_pred, aes(x = SoilTemp, y = fit1.9)) +
  geom_line(data = AbovegroundBiomass, aes(y = pred_line1.9, group = Line, colour = Line), lty = 2) +
  geom_jitter(data = AbovegroundBiomass, aes(y = AbovegroundBiomass, group = Line, colour = Line)) +
  geom_line(size = 2) +
  ylab("Above-ground biomass (g)") +
  theme_classic()+
  theme(axis.title.y=element_text(margin = margin(t = 0, r = 15, b = 0, l = 0),face="bold"),
        axis.title.x=element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), face = "bold"),
        axis.title=element_text(size=20),
        axis.text = element_text(size=20))

# Does adding line as a random intercept, slope, and curvature further improve model fit? 
AIC(model1.1, model1.2, model1.3, model1.4, model1.5, model1.6, model1.7, model1.8, model1.9)

